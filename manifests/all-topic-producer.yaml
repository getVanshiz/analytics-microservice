
apiVersion: apps/v1
kind: Deployment
metadata:
  name: all-topics-producer
  namespace: team4
spec:
  replicas: 1
  selector:
    matchLabels:
      app: all-topics-producer
  template:
    metadata:
      labels:
        app: all-topics-producer
    spec:
      containers:
        - name: all-topics-producer
          image: python:3.9-slim
          command: ["bash", "-lc"]
          args:
            - |
                pip install --no-cache-dir kafka-python && \
                python - << 'PY'
                import json, time, uuid, os, random
                from kafka import KafkaProducer

                BOOTSTRAP = os.getenv(
                    "KAFKA_BOOTSTRAP",
                    "team4-kafka-kafka-bootstrap.team4.svc:9092"
                )

                TOPICS = [
                    "user-events",
                    "order-events",
                    "notification-events"
                ]

                producer = KafkaProducer(
                    bootstrap_servers=[BOOTSTRAP],
                    value_serializer=lambda v: json.dumps(v).encode("utf-8"),
                    acks="all",
                    retries=5
                )

                print("[producer] Producing to ALL topics with trace_id enabled")

                def make_user_event():
                    return {
                        "event_id": str(uuid.uuid4()),
                        "trace_id": str(uuid.uuid4()),  # ✅ TRACE ORIGIN
                        "event_type": random.choice([
                            "user_created",
                            "user_updated",
                            "user_deleted"
                        ]),
                        "source_team": "team-1",
                        "payload": {
                            "user_id": str(uuid.uuid4()),
                            "email": f"user{random.randint(1,999)}@example.com",
                            "name": random.choice(["Vanshika", "Aarav", "Neha", "Ruhi"])
                        },
                        "produced_at": int(time.time() * 1000)
                    }

                def make_order_event():
                    return {
                        "event_id": str(uuid.uuid4()),
                        "trace_id": str(uuid.uuid4()),  # ✅ TRACE ORIGIN
                        "event_type": random.choice([
                            "order_created",
                            "order_confirmed",
                            "order_shipped"
                        ]),
                        "source_team": "team-2",
                        "payload": {
                            "order_id": str(uuid.uuid4()),
                            "user_id": str(uuid.uuid4()),
                            "amount": random.randint(100, 1500),
                            "currency": "INR"
                        },
                        "produced_at": int(time.time() * 1000)
                    }

                def make_notification_event():
                    return {
                        "event_id": str(uuid.uuid4()),
                        "trace_id": str(uuid.uuid4()),  # ✅ TRACE ORIGIN
                        "event_type": random.choice([
                            "notification_sent",
                            "notification_failed"
                        ]),
                        "source_team": "team-3",
                        "payload": {
                            "order_id": str(uuid.uuid4()),
                            "user_id": str(uuid.uuid4()),
                            "channel": random.choice(["email", "sms"])
                        },
                        "produced_at": int(time.time() * 1000)
                    }

                while True:
                    topic = random.choice(TOPICS)

                    if topic == "user-events":
                        event = make_user_event()
                    elif topic == "order-events":
                        event = make_order_event()
                    else:
                        event = make_notification_event()

                    md = producer.send(topic, event).get(timeout=10)

                    print(
                        f"[{topic}] → {event['event_type']} "
                        f"trace_id={event['trace_id']} "
                        f"offset={md.offset}",
                        flush=True
                    )

                    time.sleep(1)
                PY
          env:
            - name: KAFKA_BOOTSTRAP
              value: "team4-kafka-kafka-bootstrap.team4.svc:9092"
