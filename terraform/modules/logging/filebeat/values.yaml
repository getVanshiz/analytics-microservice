# Run as DaemonSet
daemonset:
  enabled: true
  podSecurityContext:
    runAsUser: 0

# Pass ES password from the chart-generated Secret
extraEnvs:
  - name: ES_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elasticsearch-master-credentials
        key: password

# Filebeat config: container logs -> Elasticsearch (HTTPS + auth)
filebeatConfig:
  filebeat.yml: |
    filebeat.inputs:
      - type: container
        enabled: true
        paths:
          - /var/log/containers/*.log
        processors:
          - add_kubernetes_metadata:
              host: ${NODE_NAME}
          - decode_json_fields:
              fields: ["message"]
              process_array: true
              max_depth: 4
              target: "json"
              overwrite_keys: true

    output.elasticsearch:
      hosts: ["https://elasticsearch-master.observability.svc.cluster.local:9200"]
      username: "elastic"
      password: "${ES_PASSWORD}"
      protocol: "https"
      ssl.verification_mode: "none"

    setup.template.enabled: false
    setup.ilm.enabled: false

# Host path mounts for containerd on Rancher Desktop
extraVolumes:
  - name: varlogcontainers
    hostPath: { path: /var/log/containers }
  - name: varlogpods
    hostPath: { path: /var/log/pods }

extraVolumeMounts:
  - name: varlogcontainers
    mountPath: /var/log/containers
    readOnly: true
  - name: varlogpods
    mountPath: /var/log/pods
    readOnly: true